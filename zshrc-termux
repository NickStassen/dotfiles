# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Path to your Oh My Zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Set name of the theme to load
ZSH_THEME="powerlevel10k/powerlevel10k"

# Which plugins would you like to load?
plugins=(
	git
	zsh-autosuggestions
	zsh-syntax-highlighting
	fzf
	fzf-tab
)

source $ZSH/oh-my-zsh.sh

# User configuration

# Termux-specific clipboard aliases (requires termux-api package)
if command -v termux-clipboard-set &> /dev/null; then
    alias pbcopy='termux-clipboard-set'
    alias pbpaste='termux-clipboard-get'
fi

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# Initialize zoxide (smart cd)
if command -v zoxide &> /dev/null; then
    eval "$(zoxide init zsh)"
fi

# FZF configuration
export FZF_DEFAULT_OPTS="--height 80% --layout=reverse --border"
export FZF_CTRL_T_OPTS="--preview '[[ -f {} ]] && bat --style=numbers --color=always --line-range :500 {} || [[ -d {} ]] && eza --tree --level=2 --icons --color=always {}'"
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window down:2:wrap"

# Modern CLI tool aliases
if command -v eza &> /dev/null; then
    alias ls='eza --icons --group-directories-first'
    alias ll='eza -lah --icons --group-directories-first --git'
    alias lt='eza --tree --level=2 --icons'
fi

if command -v bat &> /dev/null; then
    alias cat='bat --paging=never'
fi

# Git shortcuts
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git log --oneline --graph --decorate'
alias gd='git diff'

# Quick directory navigation
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'

# Termux-specific aliases
alias storage='termux-setup-storage'
alias notification='termux-notification'

# PR Review Function - simplified for Termux (no VSCode/browser launching)
review-pr() {
    local PR_NUMBER=$1
    local REPO_NAME=$2

    if [ -z "$PR_NUMBER" ]; then
        echo "Usage: review-pr [PR-number] [repo-name]"
        echo ""
        echo "Examples:"
        echo "  review-pr 123                # Review PR #123 in current repo"
        echo "  review-pr 123 logger         # Find 'logger' repo, review PR #123"
        return 1
    fi

    # Find repo if specified
    if [ -n "$REPO_NAME" ]; then
        local REPO_PATH=$(/data/data/com.termux/files/usr/bin/find ~/storage/shared -maxdepth 3 -type d -iname "*$REPO_NAME*" | head -1)
        if [ -z "$REPO_PATH" ]; then
            echo "Error: Could not find repo matching '$REPO_NAME'" >&2
            return 1
        fi
        cd "$REPO_PATH" || return 1
        echo "‚úì Changed to $(basename "$REPO_PATH")"
    fi

    if [ ! -d .git ]; then
        echo "Error: Not in a git repository" >&2
        return 1
    fi

    echo "üìã Fetching PR #$PR_NUMBER..."
    local PR_INFO=$(gh pr view "$PR_NUMBER" --json number,title,author,headRefName,url 2>&1)
    if [ $? -ne 0 ]; then
        echo "‚ùå Could not fetch PR #$PR_NUMBER"
        echo "$PR_INFO"
        return 1
    fi

    local PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
    local PR_BRANCH=$(echo "$PR_INFO" | jq -r '.headRefName')
    local PR_URL=$(echo "$PR_INFO" | jq -r '.url')

    echo ""
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo "‚îÇ üìù PR #$PR_NUMBER: $PR_TITLE"
    echo "‚îÇ üåø Branch: $PR_BRANCH"
    echo "‚îÇ üîó $PR_URL"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo ""

    # Checkout PR
    echo "üîÑ Checking out PR branch..."
    gh pr checkout "$PR_NUMBER" 2>&1 | grep -v "Already on" || true
    echo "‚úì On branch: $PR_BRANCH"
    echo ""

    # Copy URL to clipboard
    echo -n "$PR_URL" | pbcopy
    echo "‚úì PR URL copied to clipboard"
    echo ""
    echo "‚ú® Ready to review!"
    echo "üìç Terminal: $(pwd)"
}

# Load local secrets (not tracked in git)
[ -f ~/.zshrc.local ] && source ~/.zshrc.local
